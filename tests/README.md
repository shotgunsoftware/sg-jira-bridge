# Running the tests

To run all of these tests you must call `python run_test.py`.
Out of the box that will run a bunch of the tests, but the `test_integration.py` and `test_service.py` tests will be skipped without further setup (See bellow).

## Running test_service.py

You just need to have the [standard setup env variables](https://developer.shotgridsoftware.com/sg-jira-bridge/quickstart.html#authentication).

## Running the integration test for the bridge.
This test uses actual JIRA and Flow Production Tracking servers.

This test expects a project to have been configured in JIRA and Flow Production Tracking
according to the Quickstart page of the documentation, including the webhook
configuration and having run the `update_shotgun_users.py` script if this
test is being run against the JIRA site hosted by Atlassian.

In addition to the JIRA user used to sync data to JIRA, two other users
need to be created in JIRA with an email that matches two other users in
Flow Production Tracking. DO NOT reuse the email used by the JIRA bridge script or this
test will fail since the bridge ignores webhook events generated by that
user.

To run this test, the following environment variables need to be set:

For Flow Production Tracking access:
- `SGJIRA_SG_SITE`: The Flow Production Tracking site to use.
- `SGJIRA_SG_TEST_USER`: The login of the first user for the test.
- `SGJIRA_SG_TEST_PASSWORD`: The password for that user. Required so
    we can authenticate to Flow Production Tracking.
- `SGJIRA_SG_TEST_PROJECT`: The test project for which we should sync data.
- `SGJIRA_SG_TEST_USER_2`: The login of the second user.

For JIRA access:
- `SGJIRA_JIRA_SITE`: The JIRA site to use.
- `SGJIRA_JIRA_TEST_USER`: The login of the user that matches the first
    Flow Production Tracking test user.
- `SGJIRA_JIRA_TEST_USER_SECRET`: The secret of the user used to authenticate
    with JIRA.
- `SGJIRA_JIRA_TEST_USER_2`: The login (Jira Server) or accountId (Jira Cloud) of the user that matches the second
    Flow Production Tracking test user.
- `SGJIRA_JIRA_TEST_PROJECT_KEY`: The Jira project for which we should sync data.

`SGJIRA_JIRA_USER` and `SGJIRA_JIRA_USER_SECRET` should also have been set as part of the standard setup, but this must be a user that is different to the test users mentioned above.

The test will take care of starting and stopping the JIRA integration webapp,
but you are responsible for running your own Flow Production Tracking Event daemon.

If you already have a JIRA site up and running, whether it's on the cloud
or on-premise, you're good to go. However, you might want to run this
test against specific versions of JIRA or on a test server.

Atlassian provides docker images. You can find the documentation about them
here: https://hub.docker.com/r/atlassian/jira-software.

It can be as simple as:
docker volume create --name jira_7_13_volume
docker run -v jira_7_13_volume:/var/atlassian/application-data/jira --name="jira_7_13" -d -p 8080:8080 atlassian/jira-software:7.13

The server can then easily be stopped and started via `docker start/stop jira_7_13`.

Once you connect to the server on localhost:8080, you can request a trial license
or paste your own license.
